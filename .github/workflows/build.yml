name: Release Build

on:
  pull_request:
  push:
    branches:
      - release/**

jobs:
  windows:
    strategy:
      fail-fast: false
      matrix:
        arch: [i686, x86_64]

    name: Windows ${{ matrix.arch }}
    runs-on: windows-2019

    steps:
      - uses: actions/checkout@v2

      # When rustup is updated, it tries to replace its binary, which on Windows is somehow locked.
      # This can result in the CI failure, see: https://github.com/rust-lang/rustup/issues/3029
      - name: Disable rustup self-update
        shell: bash
        run: rustup set auto-self-update disable

      - uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af # pin@v1
        with:
          toolchain: stable-${{ matrix.arch }}-pc-windows-msvc
          profile: minimal
          override: true

      - name: Run Cargo Build
        uses: actions-rs/cargo@844f36862e911db73fe0815f00a4a2602c279505 # pin@v1
        with:
          command: build
          args: --release --locked

      - name: Check release binary
        run: .\target\release\sentry-cli.exe --help
